<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶åº­å¼€é”€è®°å½•ç³»ç»Ÿ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background: #f4f7f6; color: #333; }
        .header { display: flex; justify-content: space-between; align-items: center; background: #fff; padding: 15px 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .form-group { background: white; padding: 20px; border-radius: 10px; margin: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        input, select, button { padding: 12px; margin: 5px; border-radius: 6px; border: 1px solid #ddd; outline: none; }
        input[type="number"] { width: 100px; }
        #note { width: 200px; }
        button { cursor: pointer; transition: 0.3s; font-weight: bold; }
        .btn-add { background: #2ecc71; color: white; border: none; }
        .btn-add:hover { background: #27ae60; }
        .btn-delete { background: #ff7675; color: white; border: none; padding: 5px 10px; }
        
        /* æŠ¥å‘ŠåŒºåŸŸæ ·å¼ */
        #report-area { background: white; padding: 20px; border-radius: 8px; margin-top: 20px; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #f8f9fa; color: #666; }
        .total-section { margin-top: 20px; text-align: right; font-size: 1.2rem; font-weight: bold; color: #d63031; }
        
        .btn-png { background: #0984e3; color: white; border: none; width: 100%; margin-top: 15px; padding: 15px; font-size: 1rem; }
    </style>
</head>
<body>

<div class="header">
    <div id="display-user" style="font-weight:bold; color:#0984e3;">æ‰§è¡Œäºº: åŠ è½½ä¸­...</div>
    <button onclick="location.href='index.html'" style="background:#b2bec3; border:none; color:white;">é€€å‡º</button>
</div>

<div class="form-group">
    <h3 style="margin-top:0;">ğŸ“ æ–°å¢å¼€é”€</h3>
    <select id="category">
        <option value="å¨±ä¹">å¨±ä¹</option><option value="é¤é¥®">é¤é¥®</option>
        <option value="æ—¥å¸¸ç”¨å“">æ—¥å¸¸ç”¨å“</option><option value="åŠ æ²¹">åŠ æ²¹</option>
        <option value="æ–‡å…·">æ–‡å…·</option><option value="å­¦æ ¡ç”¨å“">å­¦æ ¡ç”¨å“</option>
        <option value="è´¦å•">è´¦å•</option><option value="æœè£…">æœè£…</option>
        <option value="ç”µå­äº§å“">ç”µå­äº§å“</option><option value="é€›è¡—">é€›è¡—</option>
    </select>
    <input type="number" id="amount" placeholder="é‡‘é¢ (RM)" step="0.01">
    <input type="text" id="note" placeholder="å¤‡æ³¨è¯¦æƒ… (Note)">
    <button class="btn-add" id="add-btn">ç¡®è®¤ä¿å­˜</button>
</div>

<div id="report-area">
    <h2 style="text-align:center; margin-bottom:5px;">å®¶åº­å¼€é”€æ—¥æŠ¥</h2>
    <p id="report-date" style="text-align:center; color:#666;"></p>
    <table>
        <thead>
            <tr>
                <th>æ—¶é—´</th>
                <th>ç±»åˆ«</th>
                <th>è¯¦æƒ… (Note)</th>
                <th>è®°å½•äºº</th>
                <th>é‡‘é¢</th>
                <th class="no-print">æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="data-list"></tbody>
    </table>
    <div class="total-section">
        ä»Šæ—¥æ€»å¼€é”€: RM <span id="total-amount">0.00</span>
    </div>
</div>

<button class="btn-png" id="download-png-btn">ğŸ“¸ ç‚¹å‡»ç”Ÿæˆå¹¶ä¸‹è½½ PNG æŠ¥å‘Š</button>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, deleteDoc, doc, serverTimestamp, where } 
    from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    // ä½ çš„ Firebase é…ç½®
    const firebaseConfig = {
        apiKey: "AIzaSyDf7cIYAh41JxBZMODy2Az4ts1GnsKEqHM",
        authDomain: "konghouse8888-60511.firebaseapp.com",
        projectId: "konghouse8888-60511",
        storageBucket: "konghouse8888-60511.firebasestorage.app",
        messagingSenderId: "943199778056",
        appId: "1:943199778056:web:688dd48183a9a1f039e8bd"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const currentUser = sessionStorage.getItem('currentUser');

    if(!currentUser) { window.location.href = 'index.html'; }
    document.getElementById('display-user').innerText = `æ‰§è¡Œäºº: ${currentUser}`;
    document.getElementById('report-date').innerText = `æ—¥æœŸ: ${new Date().toLocaleDateString()}`;

    // åŠ è½½æ•°æ®å¹¶è®¡ç®—æ€»é¢
    async function loadData() {
        const today = new Date().toISOString().split('T')[0];
        const q = query(collection(db, "expenses"), where("dateOnly", "==", today), orderBy("timestamp", "asc"));
        const snapshot = await getDocs(q);
        
        const list = document.getElementById('data-list');
        let total = 0;
        list.innerHTML = '';

        snapshot.forEach(docSnap => {
            const d = docSnap.data();
            total += d.amount;
            const timeStr = d.timestamp ? d.timestamp.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '--:--';
            
            list.innerHTML += `
                <tr>
                    <td>${timeStr}</td>
                    <td>${d.category}</td>
                    <td>${d.note || '-'}</td>
                    <td>${d.user}</td>
                    <td style="font-weight:bold;">RM ${d.amount.toFixed(2)}</td>
                    <td class="no-print"><button class="btn-delete" onclick="window.deleteItem('${docSnap.id}')">åˆ é™¤</button></td>
                </tr>`;
        });
        document.getElementById('total-amount').innerText = total.toFixed(2);
    }

    // æ·»åŠ å¼€é”€
    document.getElementById('add-btn').onclick = async () => {
        const amt = document.getElementById('amount').value;
        const cat = document.getElementById('category').value;
        const note = document.getElementById('note').value;
        
        if(!amt) return alert('è¯·è¾“å…¥é‡‘é¢');
        
        await addDoc(collection(db, "expenses"), {
            category: cat,
            amount: parseFloat(amt),
            note: note,
            user: currentUser,
            timestamp: serverTimestamp(),
            dateOnly: new Date().toISOString().split('T')[0]
        });
        
        document.getElementById('amount').value = '';
        document.getElementById('note').value = '';
        loadData();
    };

    // åˆ é™¤
    window.deleteItem = async (id) => {
        if(confirm('ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
            await deleteDoc(doc(db, "expenses", id));
            loadData();
        }
    };

    // ä¸‹è½½ PNG æŠ¥å‘Š
    document.getElementById('download-png-btn').onclick = function() {
        // éšè—ä¸éœ€è¦å‡ºç°åœ¨ç…§ç‰‡é‡Œçš„â€œæ“ä½œâ€åˆ—
        const noPrintItems = document.querySelectorAll('.no-print');
        noPrintItems.forEach(el => el.style.display = 'none');

        html2canvas(document.querySelector("#report-area")).then(canvas => {
            const link = document.createElement('a');
            link.download = `å®¶åº­æŠ¥å‘Š_${new Date().toLocaleDateString()}.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();
            
            // æ¢å¤éšè—çš„åˆ—
            noPrintItems.forEach(el => el.style.display = 'table-cell');
        });
    };

    loadData();
</script>
</body>
</html>
