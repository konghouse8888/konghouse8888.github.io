<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶åº­å¼€é”€è®°å½•ç³»ç»Ÿ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-color: #333333;
            --border-color: #eeeeee;
            --primary-color: #0984e3;
        }

        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --card-bg: #2d2d2d;
            --text-color: #e0e0e0;
            --border-color: #444444;
            --primary-color: #74b9ff;
        }

        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; padding: 10px; background: var(--bg-color); color: var(--text-color); transition: 0.3s; }
        .header { display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .form-group { background: var(--card-bg); padding: 20px; border-radius: 10px; margin: 15px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        input, select, button { padding: 12px; margin: 5px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-color); outline: none; }
        input[type="number"] { width: 110px; }
        button { cursor: pointer; transition: 0.2s; font-weight: bold; }
        
        .btn-add { background: #2ecc71; color: white; border: none; min-width: 100px; }
        .btn-add:disabled { background: #95a5a6; }
        .btn-delete { background: #ff7675; color: white; border: none; padding: 5px 10px; border-radius: 4px; }
        
        #report-area { background: var(--card-bg); padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid var(--border-color); }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.85rem; }
        th, td { padding: 10px; border-bottom: 1px solid var(--border-color); text-align: left; }
        
        .total-section { margin-top: 20px; text-align: right; font-size: 1.3rem; font-weight: bold; color: #d63031; }
        .theme-toggle { background: #636e72; color: white; border: none; padding: 8px 12px; }
        .btn-png { background: var(--primary-color); color: white; border: none; width: 100%; margin-top: 15px; padding: 15px; font-size: 1rem; border-radius: 8px; }

        @media (max-width: 600px) {
            input, select { width: 100%; box-sizing: border-box; }
            .header { flex-direction: column; gap: 10px; text-align: center; }
        }
    </style>
</head>
<body data-theme="light">

<div class="header">
    <div>
        <span id="display-user" style="font-weight:bold; color:var(--primary-color);">æ‰§è¡Œäºº: åŠ è½½ä¸­...</span>
    </div>
    <div>
        <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ“ æ¨¡å¼åˆ‡æ¢</button>
        <button onclick="location.href='index.html'" style="background:#b2bec3; color:white; border:none;">é€€å‡º</button>
    </div>
</div>

<div class="form-group">
    <h3 style="margin-top:0;">ğŸ“ æ–°å¢è®°å½•</h3>
    <select id="category">
        <option value="é¤é¥®">é¤é¥®</option><option value="å¨±ä¹">å¨±ä¹</option>
        <option value="æ—¥å¸¸ç”¨å“">æ—¥å¸¸ç”¨å“</option><option value="åŠ æ²¹">åŠ æ²¹</option>
        <option value="æ–‡å…·">æ–‡å…·</option><option value="å­¦æ ¡ç”¨å“">å­¦æ ¡ç”¨å“</option>
        <option value="è´¦å•">è´¦å•</option><option value="æœè£…">æœè£…</option>
        <option value="ç”µå­äº§å“">ç”µå­äº§å“</option><option value="é€›è¡—">é€›è¡—</option>
    </select>
    <input type="number" id="amount" placeholder="é‡‘é¢ RM" step="0.01">
    <input type="text" id="note" placeholder="å¤‡æ³¨ (Note)">
    <button class="btn-add" id="add-btn">ç¡®è®¤ä¿å­˜</button>
</div>

<div id="report-area">
    <h2 style="text-align:center; margin-bottom:5px;">å®¶åº­å¼€é”€æ—¥æŠ¥</h2>
    <p id="report-date" style="text-align:center; opacity: 0.8; margin-bottom: 15px;"></p>
    <table>
        <thead>
            <tr>
                <th>æ—¶é—´</th>
                <th>æ‰§è¡Œäºº</th> <th>ç±»åˆ«</th>
                <th>å¤‡æ³¨</th>
                <th>é‡‘é¢</th>
                <th class="no-print">æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="data-list"></tbody>
    </table>
    <div class="total-section">
        ä»Šæ—¥æ€»è®¡: <span style="font-size: 0.9rem;">RM</span> <span id="total-amount">0.00</span>
    </div>
</div>

<button class="btn-png" id="download-png-btn">ğŸ“¸ ç”Ÿæˆå›¾ç‰‡æŠ¥å‘Š</button>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, deleteDoc, doc, serverTimestamp } 
    from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDf7cIYAh41JxBZMODy2Az4ts1GnsKEqHM",
        authDomain: "konghouse8888-60511.firebaseapp.com",
        projectId: "konghouse8888-60511",
        storageBucket: "konghouse8888-60511.firebasestorage.app",
        messagingSenderId: "943199778056",
        appId: "1:943199778056:web:688dd48183a9a1f039e8bd"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const currentUser = sessionStorage.getItem('currentUser');

    if(!currentUser) { window.location.href = 'index.html'; }
    document.getElementById('display-user').innerText = `å½“å‰æ‰§è¡Œäºº: ${currentUser}`;
    document.getElementById('report-date').innerText = `æ—¥æœŸ: ${new Date().toLocaleDateString()}`;

    window.toggleTheme = () => {
        const body = document.body;
        const newTheme = body.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
        body.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
    };
    if(localStorage.getItem('theme')) document.body.setAttribute('data-theme', localStorage.getItem('theme'));

    async function loadData() {
        try {
            const q = query(collection(db, "expenses"), orderBy("timestamp", "desc"));
            const snapshot = await getDocs(q);
            const list = document.getElementById('data-list');
            const todayStr = new Date().toISOString().split('T')[0];
            let total = 0;
            list.innerHTML = '';

            snapshot.forEach(docSnap => {
                const d = docSnap.data();
                if (d.dateOnly === todayStr) {
                    total += d.amount;
                    let timeStr = d.timestamp ? d.timestamp.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    list.innerHTML += `
                        <tr>
                            <td>${timeStr}</td>
                            <td style="color:var(--primary-color); font-weight:bold;">${d.user || 'æœªçŸ¥'}</td>
                            <td>${d.category}</td>
                            <td>${d.note || '-'}</td>
                            <td style="font-weight:bold;">RM ${d.amount.toFixed(2)}</td>
                            <td class="no-print"><button class="btn-delete" onclick="window.deleteItem('${docSnap.id}')">åˆ é™¤</button></td>
                        </tr>`;
                }
            });
            document.getElementById('total-amount').innerText = total.toFixed(2);
        } catch (e) { console.error(e); }
    }

    document.getElementById('add-btn').onclick = async () => {
        const btn = document.getElementById('add-btn');
        const amt = document.getElementById('amount').value;
        const cat = document.getElementById('category').value;
        const note = document.getElementById('note').value;
        if(!amt) return alert('è¯·è¾“å…¥é‡‘é¢');
        
        btn.disabled = true;
        btn.innerText = "ä¿å­˜ä¸­...";
        try {
            await addDoc(collection(db, "expenses"), {
                category: cat,
                amount: parseFloat(amt),
                note: note,
                user: currentUser, // è¿™é‡Œä¿å­˜äº†æ˜¯è°åšçš„å¼€é”€
                timestamp: serverTimestamp(),
                dateOnly: new Date().toISOString().split('T')[0]
            });
            document.getElementById('amount').value = '';
            document.getElementById('note').value = '';
            await loadData();
        } finally {
            btn.disabled = false;
            btn.innerText = "ç¡®è®¤ä¿å­˜";
        }
    };

    window.deleteItem = async (id) => {
        if(confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')) {
            await deleteDoc(doc(db, "expenses", id));
            loadData();
        }
    };

    document.getElementById('download-png-btn').onclick = function() {
        const noPrint = document.querySelectorAll('.no-print');
        noPrint.forEach(el => el.style.display = 'none');
        html2canvas(document.querySelector("#report-area"), {
            backgroundColor: getComputedStyle(document.body).getPropertyValue('--card-bg'),
            scale: 2
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = `Report_${new Date().toISOString().split('T')[0]}.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();
            noPrint.forEach(el => el.style.display = 'table-cell');
        });
    };

    loadData();
</script>
</body>
</html>
